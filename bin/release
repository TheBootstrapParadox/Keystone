#!/bin/bash

# Release script for Keystone
# Usage: ./bin/release [version]
# Example: ./bin/release 1.0.0

set -e

VERSION=$1

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if version argument is provided
if [ -z "$VERSION" ]; then
    echo -e "${YELLOW}Usage: ./bin/release [version]${NC}"
    echo -e "${YELLOW}Example: ./bin/release 1.0.0${NC}"
    echo ""
    echo "Current version:"
    git describe --tags --abbrev=0 2>/dev/null || echo "No version tags yet"
    exit 1
fi

# Add 'v' prefix if not present
if [[ ! $VERSION =~ ^v ]]; then
    VERSION="v$VERSION"
fi

# Validate semantic version format
if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$ ]]; then
    echo -e "${RED}Error: Invalid version format. Use semantic versioning (e.g., 1.0.0 or 1.0.0-beta.1)${NC}"
    exit 1
fi

# Check if tag already exists
if git rev-parse "$VERSION" >/dev/null 2>&1; then
    echo -e "${RED}Error: Tag $VERSION already exists${NC}"
    exit 1
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo -e "${RED}Error: You have uncommitted changes. Please commit or stash them first.${NC}"
    git status --short
    exit 1
fi

# Confirm release
echo -e "${YELLOW}Creating release: $VERSION${NC}"
echo ""
echo "Current branch: $(git branch --show-current)"
echo "Latest commit: $(git log -1 --oneline)"
echo ""
read -p "Continue with release? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Release cancelled."
    exit 1
fi

# Create annotated tag
echo -e "${GREEN}Creating tag $VERSION...${NC}"
git tag -a "$VERSION" -m "Release $VERSION"

# Push tag to origin
echo -e "${GREEN}Pushing tag to origin...${NC}"
git push origin "$VERSION"

echo ""
echo -e "${GREEN}âœ“ Successfully released $VERSION${NC}"
echo ""
echo "Next steps:"
echo "  - Packagist will auto-update (if webhook is configured)"
echo "  - Users can install with: composer require bspdx/keystone:$VERSION"
echo "  - Create release notes on GitHub: https://github.com/TheBootstrapParadox/Keystone/releases/new?tag=$VERSION"
